language: android
sudo: false
jdk: oraclejdk8

before_cache:
 -rm -f $HOME/.gradle/caches/modules-2/modules-2.lock
 -rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
    
env:
  global:
    - ANDROID_API=25
    - EMULATOR_API=22
    - ANDROID_BUILD_TOOLS=27.0.0
    - secure: "bQ8peKvxrqBoHMkrhJTPGkdVL04C2ZWT10RcQ5Ns2+UTlSa1UqL8GkVAejZIqDKktHM26jzKAjbAsqmOohRoc6g/PNaoMyIcFBjIcqGBflw0tHujT8jwVyHdMflTFyXH6+EhxvSY0Rngm7Mum1+RDhYxOiTIDBIHruXUXR/HcOF1yyyfn6Bx4pj6aKAxaAg2ItLCAfgd7sFfOOwBj5pysEGtB8vlFcxuxJvIC22oY5D79J2UoQtiy8uOXagbPRjRbAKPp2tirVUHW1kFj2w917Pm/Z5aE5jmoNOHC1sltEs7OYMH/IB3PAb7FGMza4zyFQtcgHbag5hB3X8lDQgN0KvSftg6hfec2qpltH7bgsz+CiwdskLc3tpK/51h5bMDH9xXglP8uSflZdJHU2cZXfxd3cBPPjGM3cFwjdYD3dzlxd8CV+BT4l9DM+gqvGNlYksm4StAup0SlguWzyN0jr8d5JOiFc2wdjm4y5u4A6cO5992TRFbNBCZeqKzToDo5FL2lTbCnNGg4YpPpwPdbOArourJIQj5pYLfSP7nItg2eOidE0Kj6+dZgPWfuKZqKvUDyj/iTAfFCkG3t6Od0MSNiXtiOLoUtQ/mNTonyFJL8MZ12SaxqqxZnIEMFuEQjrI8ql+uPOct1zxG7qR+66RRg4AMp452WjnWdZhsiYE="
    - secure: "CLL313XTAZK5LDDUrx/bosQtuUbfv0PtL2TTe/KiTiVr9V4HIkkBiakeSmjCmxeqmK17sUzs2EOwYOTaOhOOyrQPiHXRyVEfh3IaDktJEV0CmiGxB87FNcD3I37QCD43rF/uSMMxZwxNMnqimip/1/bck5Z02kCS++n7UgsLu6iKpKjUUweq+NyHqWDf7qPUAB4PGmct/C2R9SsqF+m5ZQUBKg96gBMiXMVTm+uX4MbUBZRsjPICQKx2wHPwUj0v1/IoEi/AjssTUhd2VpMclEQvI7zxrDjNwvy5wh9QDREhCs+GxVgNVTTNQK003rbXa+yQ09WMwIXPqSlY6dbujBgI5+W+KNT7/7otMaXrzSZf9SMUQMMPJbVS2XzyNM2N1HnOjMfpEzaVREv8eFJhFYx7vZKFtsbgL2L/i++Q7MSlFsNuE8h9vy93Nu0nYCeUmwmrYcxG5yNhCJPUA5E3wTrml2her/2/xmmh8UTyPDYYkulI6G6WykrinEBJWyw24uWwjPiwFy/Zi+cPtVBNePreV2bZFOYW7CpPzLVaVd22vm81GdHrfJGFGWAnIwDEijx8MDwuL7y5W7uyvcPQu6yH8ZWnCd71u8TfSTNh/fR366SHn5TW2QhL93U50anqAE50NcB2VyyeutnlHjr6ztOztYZSkoiZYCffEWzgXXk="

android:
  components:
    - tools
    - platform-tools
    
    - build-tools-$ANDROID_BUILD_TOOLS
    - android-$ANDROID_API
    - android-$EMULATOR_API
    
    - extra-google-google_play_services
    - extra-google-m2repository
    - extra-android-m2repository
    
    - sys-img-armeabi-v7a-addon-google_apis-google-$ANDROID_API
    - sys-img-armeabi-v7a-android-$EMULATOR_API
    
licenses:
  - android-sdk-preview-license-.+
  - android-sdk-license-.+
  - google-gdk-license-.+

before_install:
  - openssl aes-256-cbc -K $encrypted_cead1202e152_key -iv $encrypted_cead1202e152_iv -in keystore.jks.enc -out keystore.jks -d

before_script:
  - echo no | android create avd --force -n test -t android-$EMULATOR_API --abi armeabi-v7a
  - emulator -avd test -no-window &
  - android-wait-for-emulator
  - adb shell input keyevent 82 &

before_deploy:
  - cp $TRAVIS_BUILD_DIR/keystore.jks $HOME
  - cd app/build/outputs/apk/
  - ls -la
  - jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore $HOME/keystore.jks -storepass $storepass -keypass $keypass app-unsigned.apk key0

  # Verification
  - jarsigner -verify app-release-unsigned.apk
  - "${ANDROID_HOME}/build-tools/27.0.0/zipalign -v 4 app-release-unsigned.apk SteamBadger.apk"

deploy:
  provider: releases
  api_key: $GITPERM
  skip_cleanup: true
  file:
    - "README.md"
    - "SteamBadger.apk"
  on:
    tags: true
